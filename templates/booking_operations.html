{% extends "base.html" %}

{% block title %} Booking {{mode|capitalize}} {% endblock %}

{% block content %}
<style>
    :root {
        --primary-gradient: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
        --danger-gradient: linear-gradient(135deg, #dc3545 0%, #a71d2a 100%);
    }
    body { background-color: #f8f9fa; font-family: 'Inter', sans-serif; }
    .booking-card { border: none; border-radius: 1.25rem; overflow: hidden; }
    .header-gradient-primary { background: var(--primary-gradient); }
    .header-gradient-danger { background: var(--danger-gradient); }
    .form-section-title { position: relative; padding-bottom: 0.5rem; margin-bottom: 1.5rem; }
    .form-section-title::after { content: ''; position: absolute; left: 0; bottom: 0; width: 50px; height: 3px; background: #0d6efd; border-radius: 3px; }
    .form-control, .form-select { padding: 0.75rem 1rem; border: 1px solid #dee2e6; transition: all 0.2s ease-in-out; }
    .form-control:focus, .form-select:focus { border-color: #0d6efd; box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.1); transform: translateY(-1px); }
    .invoice-box { transition: all 0.3s ease; border: 1px solid rgba(13, 110, 253, 0.1); }
    .btn-action { padding: 1rem; border-radius: 0.75rem; transition: all 0.3s ease; }
    .btn-action:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
</style>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-xl-10">
            <div class="card booking-card shadow-lg">
                <div class="card-header border-0 p-4 text-white text-center {% if mode == 'delete' %}header-gradient-danger{% else %}header-gradient-primary{% endif %}">
                    <h2 class="mb-1 fw-bold">
                        {% if mode=='insert' %}Create New Booking
                        {% elif mode=='update' %}Update Reservation
                        {% else %}Cancel Reservation{% endif %}
                    </h2>
                    <p class="mb-0 opacity-75">Please fill in the details below to process the request</p>
                </div>

                <div class="card-body p-4 p-md-5">
                    <form method="post" id="bookingForm" class="needs-validation" novalidate>
                        
                        <div class="mb-5">
                            <h5 class="form-section-title fw-bold text-dark text-uppercase small letter-spacing-1">
                                <i class="bi bi-person-lines-fill me-2"></i>Guest Information
                            </h5>
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">First Name</label>
                                    <input type="text" name="firstname" class="form-control" placeholder="John"
                                    value="{% if inputData and inputData.firstname %}{{ inputData.firstname }}
                                            {% elif booking %}{{ booking.first_name }}{% else %}{% endif %}"
                                    {% if mode == 'delete' %}disabled{% endif %} required>
                                    <div class="text-danger small mt-1">{{ errorList.firstname if errorList and errorList.firstname }}</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Last Name</label>
                                    <input type="text" name="lastname" class="form-control" placeholder="Doe" 
                                    value="{{inputData.lastname if inputData else (booking.last_name if booking else '')}}"
                                    {% if mode == 'delete' %}disabled{% endif %} required>
                                    <div class="text-danger small mt-1">{{ errorList.lastname if errorList and errorList.lastname }}</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Email Address</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light border-end-0"><i class="bi bi-envelope"></i></span>
                                        <input type="email" name="email" class="form-control border-start-0" placeholder="john@example.com"
                                        value="{% if inputData and inputData.email %}{{ inputData.email }}
                                            {% elif booking %}{{ booking.email }}{% else %}{% endif %}"
                                        {% if mode == 'delete' %}disabled{% endif %} required>
                                    </div>
                                    <div class="text-danger small mt-1">{{ errorList.email if errorList and errorList.email }}</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Phone Number</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light border-end-0"><i class="bi bi-phone"></i></span>
                                        <input type="text" name="phoneNumber" class="form-control border-start-0" placeholder="09..."
                                        value="{% if inputData and inputData.phoneNumber %}{{ inputData.phoneNumber }}
                                            {% elif booking %}{{ booking.phone }}{% else %}{% endif %}"
                                        {% if mode == 'delete' %}disabled{% endif %} required>
                                    </div>
                                    <div class="text-danger small mt-1">{{ errorList.phone if errorList and errorList.phone }}</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Date of Birth</label>
                                    <input type="date" name="dob" class="form-control" 
                                    value="{{ inputData.get('dob') if inputData else (booking.dob if booking else '')}}"
                                    {% if mode == 'delete' %}disabled{% endif %} required>
                                    <div class="text-danger small mt-1">{{ errorList.dob if errorList and errorList.dob }}</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Country</label>
                                    <input type="text" name="country" class="form-control" 
                                    value="{% if inputData and inputData.country %}{{ inputData.country }}
                                            {% elif booking %}{{ booking.country }}{% else %}{% endif %}"
                                    {% if mode == 'delete' %}disabled{% endif %} required>
                                    <div class="text-danger small mt-1">{{ errorList.country if errorList and errorList.country }}</div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-5">
                            <h5 class="form-section-title fw-bold text-dark text-uppercase small letter-spacing-1">
                                <i class="bi bi-house-door me-2"></i>Stay Details
                            </h5>
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold text-primary"><i class="bi bi-box-arrow-in-right me-1"></i>Check-In Date</label>
                                    {% if mode == 'delete' or (mode=='update' and booking.status in ['Check in','Check out']) %}
                                        <input type="datetime-local" class="form-control bg-light" value="{{ booking.check_in_date if booking else '' }}" disabled>
                                        <input type="hidden" name="check_in_date" value="{{ inputData.get('check_in_date') if inputData else (booking.check_in_date if booking else '') }}">
                                    {% else %}
                                        <input type="datetime-local" id="check_in_date" name="check_in_date" class="form-control" 
                                        value="{{ inputData.get('check_in_date') if inputData else (booking.check_in_date if booking else '') }}" required>
                                    {% endif %}
                                    <div class="text-danger small mt-1">{{ errorList.check_in_date if errorList and errorList.check_in_date }}</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold text-danger"><i class="bi bi-box-arrow-left me-1"></i>Check-Out Date</label>
                                    {% if mode == 'delete' or (mode=='update' and booking.status=='Check out') %}
                                        <input type="datetime-local" class="form-control bg-light" value="{{ booking.check_out_date if booking else '' }}" disabled>
                                        <input type="hidden" name="Check_Out_Date" value="{{ inputData.get('Check_Out_Date') if inputData else (booking.check_out_date if booking else '') }}">
                                    {% else %}
                                        <input type="datetime-local" id="Check_Out_Date" name="Check_Out_Date" class="form-control" 
                                        value="{{ inputData.get('Check_Out_Date') if inputData else (booking.check_out_date if booking else '') }}" required>
                                    {% endif %}
                                    <div class="text-danger small mt-1">{{ errorList.check_out_date if errorList and errorList.check_out_date }}</div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-semibold">Adults</label>
                                    <select name="Noadults" class="form-select" {% if mode == 'delete' %}disabled{% endif %} required>
                                        <option value="" disabled selected>Select</option>
                                        {% for i in range(1, 4) %}
                                        <option value="{{i}}" 
                                        {% if inputData and inputData.get('Noadults')|int == i %}
                                        selected
                                        {% elif booking and booking.no_of_adults|int == i %}
                                        selected
                                        {% endif %}>{{i}}</option>
                                        {% endfor %}
                                    </select>
                                    <div class="text-danger small mt-1">{{ errorList.Noadults if errorList and errorList.Noadults }}</div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-semibold">Kids</label>
                                    <select name="Nokids" class="form-select" {% if mode == 'delete' %}disabled{% endif %} required>
                                        {% for i in range(0, 4) %}
                                        <option value="{{i}}" 
                                        {% if inputData and inputData.get('Nokids')|int == i %}
                                        selected
                                        {% elif booking and booking.no_of_kids|int == i %}
                                        selected
                                        {% endif %}>
                                        {{i}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-semibold">Room Number</label>
                                    <select id="room_no" name="room_no" class="form-select fw-bold text-primary" {% if mode == 'delete' %}disabled{% endif %} required>
                                        <option value="" disabled selected>Select Room</option>
                                        {% for room in available_rooms %}
                                            <option value="{{ room }}" 
                                            {% if inputData and inputData.get('room_no')|string == room|string %}
                                            selected
                                            {% elif booking and booking.room_no|string == room|string %}
                                             selected
                                            {% endif %}>
                                            Room {{ room }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                    <div class="text-danger small mt-1">{{ errorList.room_no if errorList and errorList.room_no }}</div>
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-semibold">Reservation Status</label>
                                    {% if mode=='update' and booking.status=='Check out' or mode=='delete' %}
                                        <div class="alert alert-secondary border-0 mb-0 py-2">{{ booking.status }}</div>
                                        <input type="hidden" name="status" value="{{ booking.status }}">
                                    {% else %}
                                        <select name="status" class="form-select shadow-sm border-2" required>
                                            <option value="Booked" {{ 'selected' if booking.status=='Booked' }} {% if mode=='update' and booking.status in ['Check in','Check out'] %}disabled{% endif %}>Booked</option>
                                            <option value="Check in" {{ 'selected' if booking.status=='Check in' }} {% if mode=='update' and booking.status=='Check out' %}disabled{% endif %}>Check In</option>
                                            <option value="Check out" {{ 'selected' if booking.status=='Check out' }} {% if mode=='insert' %}disabled{% endif %}>Check Out</option>
                                        </select>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="mb-5">
                            <h5 class="form-section-title fw-bold text-dark text-uppercase small letter-spacing-1">
                                <i class="bi bi-shield-check me-2"></i>Payment Details
                            </h5>
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Payment Method</label>
                                    <select name="payment_type" class="form-select" {% if mode == 'delete' %}disabled{% endif %}>
                                        <option {{ 'selected' if booking.payment_type|lower == 'visa' }}>Visa</option>
                                        <option {{ 'selected' if booking.payment_type|lower == 'master' }}>Master</option>
                                        <option {{ 'selected' if booking.payment_type|lower == 'americanexpress' }}>American Express</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Card Holder Name</label>
                                    <input type="text" name="holder_name" class="form-control" 
                                    value="{{inputData.holder_name if inputData.holder_name else (booking.holder_name if booking else '') }}" 
                                    {% if mode == 'delete' %}disabled{% endif %} required>
                                    <div class="text-danger small mt-1">{{ errorList.holder_name if errorList and errorList.holder_name }}</div>
                                </div>
                                <div class="col-md-8">
                                    <label class="form-label fw-semibold">Card Number</label>
                                    <input type="text" name="card_number" class="form-control" placeholder="0000 0000 0000 0000"
                                    value="{{ inputData.card_number if inputData.card_number else(booking.card_number if booking else '') }}" 
                                    {% if mode == 'delete' %}disabled{% endif %} required>
                                    <div class="text-danger small mt-1">{{ errorList.card_number if errorList and errorList.card_number }}</div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-semibold">CVV</label>
                                    <input type="text" name="CVV" class="form-control" placeholder="123"
                                    value="{{inputData.CVV if inputData.CVV else(booking.CVV if booking else '') }}" {% if mode == 'delete' %}disabled{% endif %} required>
                                    <div class="text-danger small mt-1">{{ errorList.CVV if errorList and errorList.CVV }}</div>
                                </div>
                            </div>
                        </div>

                        <div class="row g-4">
                            <div class="col-lg-6">
                                <div class="card invoice-box rounded-4 p-4 bg-light border-0 h-100">
                                    <h6 class="fw-bold mb-3 d-flex justify-content-between">
                                        Summary <span><i class="bi bi-receipt"></i></span>
                                    </h6>
                                    <div class="d-flex justify-content-between mb-2 small text-muted">
                                        <span>Nightly Rate:</span>
                                        <span>$<span id="one_room_price">{{ price_per_room if mode!='insert' else (inputData.get('price') if inputData else 0) }}</span></span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-3 small text-muted">
                                        <span>Total Stay:</span>
                                        <span><span id="stays">{{ stays if mode != 'insert' else (inputData.get('diffDays') if inputData else 0) }}</span> nights</span>
                                    </div>
                                    <div class="pt-3 border-top d-flex justify-content-between align-items-center">
                                        <span class="h6 mb-0 fw-bold">Grand Total</span>
                                        <span class="h4 mb-0 fw-bolder text-primary">
                                            {% if mode == 'insert' %}
                                                $<span id="room_price_display">
                                                    {{inputData.get('price') if inputData else '0.00'}}
                                                </span>
                                                <input type="hidden" name="price" id="price" value="{{inputData.get('price') if inputData else ''}}">
                                            {% else %}
                                                ${{ "{:,.2f}".format(booking.totalprice) if booking else '0.00' }}
                                            {% endif %}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6 d-flex flex-column justify-content-center">
                                <button type="submit" class="btn btn-action w-100 mb-3 fw-bold shadow-sm {% if mode == 'delete' %}btn-danger{% else %}btn-primary{% endif %}">
                                    {% if mode == 'insert' %}Confirm & Create Booking
                                    {% elif mode == 'update' %}Apply Changes
                                    {% else %}Delete Forever{% endif %}
                                </button>
                                <a href="{{ url_for('manage_booking') }}" class="btn btn-outline-secondary btn-action w-100">
                                    Cancel & Exit
                                </a>
                            </div>
                        </div>

                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% if mode == 'insert' %}
<script>
document.addEventListener("DOMContentLoaded", function() {
  const roomSelect = document.getElementById("room_no");
  const checkIn = document.getElementById("check_in_date");
  const checkOut = document.getElementById("Check_Out_Date");
  const priceDisplay = document.getElementById("room_price_display");
  const priceInput = document.getElementById("price");
  const one_room_price = document.getElementById("one_room_price");
  const stays = document.getElementById("stays");

if (roomSelect.value && checkIn.value && checkOut.value) {
  function updatePrice() {
    const room_no = roomSelect.value;
    const check_in = checkIn.value;
    const check_out = checkOut.value;

    if (!room_no || !check_in || !check_out) {
      priceDisplay.textContent = "0.00";
      priceInput.value = "";
      return;
    }

    fetch(`/get_room_price?room_no=${room_no}`)
      .then(response => response.json())
      .then(data => {
        const checkInDate = new Date(check_in);
        const checkOutDate = new Date(check_out);
        const today = new Date();
        today.setHours(0,0,0,0);
        checkInDate.setHours(0,0,0,0);
        checkOutDate.setHours(0,0,0,0);

        if (checkInDate < today) {
          alert("Check-in date cannot be earlier than today!");
          return;
        }
        if (checkOutDate <= checkInDate) {
          alert("Check-out date must be after check-in date!");
          return;
        }

        const diffTime = Math.abs(checkOutDate - checkInDate);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        const totalPrice = data.price * diffDays;
        priceDisplay.textContent = totalPrice.toFixed(2);
        priceInput.value = totalPrice;
        one_room_price.textContent = data.price;
        stays.textContent = diffDays;
      });
  }
}
  roomSelect.addEventListener("change", updatePrice);
  checkIn.addEventListener("change", updatePrice);
  checkOut.addEventListener("change", updatePrice);
});
</script>
{% endif %}

{% endblock %}