{% extends "base.html" %}

{% block title %} Booking {{model}} {% endblock %}

{% block content %}
<div class="container mt-5 d-flex justify-content-center">
  <div class="card shadow-sm w-75">
    <div class="card-header bg-primary text-white text-center">
      <h4 class="mb-0">
        {% if mode=='insert' %}<i class="bi bi-plus-circle"></i>Add New Booking
        {% elif mode=='update' %}<i class="bi bi-pencil-square"></i>Update Booking
        {% else %}<i class="bi bi-trash"></i>Delete Booking{% endif %}
      </h4>
    </div>
    <div class="card-body">
      <form method="post" class="row g-3">
        <!-- First Name -->
        <div class="col-md-6">
          <label for="firstname" class="form-label fw-bold">First Name</label>
          <input type="text" id="firstname" name="firstname" class="form-control" placeholder="Enter First name"
          value="{{ booking.first_name if booking else ' ' }}"
          {% if mode == 'delete' %}disabled{% endif %} required>
          <div id="firstnameError" class="text-danger mt-1">{{ errorList.firstname if errorList and errorList.firstname }}</div>
        </div>
        
        <!-- Last Name -->
        <div class="col-md-6">
          <label for="lastname" class="form-label fw-bold">Last Name</label>
          <input type="text" id="lastname" name="lastname" class="form-control" placeholder="Enter Last Name" 
           value="{{inputData.last_name if inputData.last_name else (booking.last_name if booking else ' ') }}"
           {% if mode == 'delete' %}disabled{% endif %} required>
          <div id="lastnameError" class="text-danger mt-1">{{ errorList.lastname if errorList and errorList.lastname }}</div>
        </div>

        <!-- Email -->
        <div class="col-md-6">
          <label for="email" class="form-label fw-bold">Email</label>
          <input type="text" id="email" name="email" class="form-control" placeholder="Enter Email"
          value="{{ booking.email if booking else ' ' }}"
          {% if mode == 'delete' %}disabled{% endif %} required>
          <div id="emailError" class="text-danger mt-1">{{ errorList.email if errorList and errorList.email }}</div>
        </div>

        <!-- Phone Number -->
        <div class="col-md-6">
          <label for="phoneNumber" class="form-label fw-bold">Phone Number</label>
          <input type="text" id="phoneNumber" name="phoneNumber" class="form-control" placeholder="Enter Phone Number"
          value="{{ booking.phone if booking else ' ' }}"
          {% if mode == 'delete' %}disabled{% endif %} required>
          <div id="nameError" class="text-danger mt-1">{{ errorList.phone if errorList and errorList.phone }}</div>
        </div>

        <!-- DOB -->
        <div class="col-md-6">
          <label for="dob" class="form-label fw-bold">Date of Birth</label>
          <input type="date" id="dob" name="dob" class="form-control" placeholder="Date of Birth"
          value="{{ booking.dob if booking else ' ' }}"
          {% if mode == 'delete' %}disabled{% endif %} required>    
          <div id="dobError" class="text-danger mt-1">{{ errorList.dob if errorList and errorList.dob }}</div>
        </div>

        <!-- Country -->
        <div class="col-md-6">
          <label for="country" class="form-label fw-bold">Country</label>
          <input type="text" id="country" name="country" class="form-control" placeholder="Enter country"
          value="{{ booking.country if booking else ' ' }}"
          {% if mode == 'delete' %}disabled{% endif %} required>
          <div id="countryError" class="text-danger mt-1">{{ errorList.country if errorList and errorList.country }}</div>
        </div>

         <!-- Check in date -->
        <!-- <div class="col-md-6">
          <label for="check_in_date" class="form-label fw-bold">Check in Date</label>
          <input type="datetime-local" id="check_in_date" name="check_in_date" class="form-control" placeholder="Check-In-Date"
          value="{{ booking.check_in_date if booking else ' ' }}"
          {% if mode == 'delete' %}disabled{% endif %} {% if mode=='update' and booking.status in ['Check in','Check out'] %}readonly{% endif %} required>
          <div id="check_in_dateError" class="text-danger mt-1">{{ errorList.check_in_date if errorList and errorList.check_in_date }}</div>
        </div> -->

        <!-- Check in date -->
<div class="col-md-6">
  <label for="check_in_date" class="form-label fw-bold">Check in Date</label>

  {% if mode == 'delete' or (mode=='update' and booking.status in ['Check in','Check out']) %}
    <!-- Disabled for UI -->
    <input type="datetime-local"
           class="form-control"
           value="{{ booking.check_in_date if booking else '' }}"
           disabled>

    <!-- Hidden input to submit value -->
    <input type="hidden"
           name="check_in_date"
           value="{{ booking.check_in_date if booking else '' }}">
  {% else %}
    <input type="datetime-local"
           id="check_in_date"
           name="check_in_date"
           class="form-control"
           placeholder="Check-In-Date"
           value="{{ booking.check_in_date if booking else '' }}"
           required>
  {% endif %}

  <div id="check_in_dateError" class="text-danger mt-1">
    {{ errorList.check_in_date if errorList and errorList.check_in_date }}
  </div>
</div>

        
        
        <!-- Check out date -->
        <!-- <div class="col-md-6">
          <label for="Check-Out-Date" class="form-label fw-bold">Check out date</label>
          <input type="datetime-local" id="Check-Out-Date" name="Check-Out-Date" class="form-control" placeholder="Check-Out-Date"
          value="{{  booking.check_out_date if booking else ' ' }}"
          {% if mode == 'delete' or (mode=='update' and booking.status=='Check out') %}readonly{% endif %} required>
          <div id="Check-Out-DateError" class="text-danger mt-1">{{ errorList.check_out_date if errorList and errorList.check_out_date }}</div>
        </div> -->

        <!-- Check out date -->
<div class="col-md-6">
  <label for="Check-Out-Date" class="form-label fw-bold">Check out date</label>

  {% if mode == 'delete' or (mode=='update' and booking.status=='Check out') %}
    <!-- Disabled input for UX -->
    <input type="datetime-local"
           class="form-control"
           value="{{ booking.check_out_date if booking else '' }}"
           disabled>

    <!-- Hidden input to submit value -->
    <input type="hidden"
           name="Check-Out-Date"
           value="{{ booking.check_out_date if booking else '' }}">
  {% else %}
    <input type="datetime-local"
           id="Check-Out-Date"
           name="Check-Out-Date"
           class="form-control"
           placeholder="Check-Out-Date"
           value="{{ booking.check_out_date if booking else '' }}"
           required>
  {% endif %}

  <div id="Check-Out-DateError" class="text-danger mt-1">
    {{ errorList.check_out_date if errorList and errorList.check_out_date }}
  </div>
</div>


        <!-- Number of adults -->
        <div class="col-md-6">
          <label for="Noadults" class="form-label fw-bold">How many adults</label>
          <select id="Noadults" name="Noadults" class="form-select" {% if mode == 'delete' %}disabled{% endif %} required>        
            <option value="" disabled selected>select one</option>
            <option {{ 'selected' if booking.no_of_adults==1 }}>1</option>
            <option {{ 'selected' if booking.no_of_adults==2 }}>2</option>
            <option {{ 'selected' if booking.no_of_adults==3 }}>3</option>
          </select>
          <div id="NoadultsError" class="text-danger mt-1">{{ errorList.Noadults if errorList and errorList.Noadults }}</div>
        </div>

        <!-- Number of kids -->
        <div class="col-md-6">
          <label for="Nokids" class="form-label fw-bold">How many kids</label>
          <select id="Nokids" name="Nokids" class="form-select" {% if mode == 'delete' %}disabled{% endif %} required>        
            <option value="" disabled selected>select one</option>
            <option value="0" {{ 'selected' if booking.no_of_kids==0 }}>0</option>
            <option value="1" {{ 'selected' if booking.no_of_kids==1 }}>1</option>
            <option value="2" {{ 'selected' if booking.no_of_kids==2 }}>2</option>
            <option value="3" {{ 'selected' if booking.no_of_kids==3 }}>3</option>
          </select>
          <div id="NokidsError" class="text-danger mt-1">{{ errorList.Nokids if errorList and errorList.Nokids }}</div>
        </div>

        <!-- Room Number -->
        <div class="col-md-6">
          <label for="room_no" class="form-label fw-bold">Room Number</label>
          <select id="room_no" name="room_no" class="form-select" {% if mode == 'delete' %}disabled{% endif %} required>        
            {% if available_rooms %}
              <option value="" disabled selected>Select a room</option>
              {% for room in available_rooms %}
                  <option value="{{ room }}" 
                    {% if booking and booking.room_no|string == room %}selected{% endif %}>
                          {{ room }}
                  </option>
              {% endfor %}
            {% endif %}
        
          </select>
        </div>

        <!-- Status -->
<div class="col-md-6">
  <label for="status" class="form-label fw-bold">Status</label>

  {% if mode=='update' and booking.status=='Check out' or mode=='delete' %}
    <!-- Show disabled select for UX -->
    <select id="status" class="form-select" disabled>
      <option selected>{{ booking.status }}</option>
    </select>
    <!-- Hidden input to submit value to backend -->
    <input type="hidden" name="status" value="{{ booking.status }}">
  {% else %}
    <select id="status" name="status" class="form-select" required>
      <option value="Booked" 
        {{ 'selected' if booking.status=='Booked' }} 
        {% if mode=='update' and booking.status in ['Check in','Check out'] %}disabled{% endif %}>
        Booked
      </option>
      <option value="Check in" 
        {{ 'selected' if booking.status=='Check in' }} 
        {% if mode=='update' and booking.status=='Check out' %}disabled{% endif %}>
        Check in
      </option>
      <option value="Check out" {{ 'selected' if booking.status=='Check out' }}> Check out
      </option>
    </select>
  {% endif %}
</div>


        <!-- Payment type -->
        <div class="col-md-6"> 
          <label for="payment_type" class="form-label fw-bold">Payment Type</label>
          <select id="payment_type" name="payment_type" class="form-select" 
          {% if mode == 'delete' %}disabled{% endif %} required>
            <option {{ 'selected' if booking.payment_type and booking.payment_type.lower()=='visa' }}>Visa</option>
            <option {{ 'selected' if booking.payment_type and booking.payment_type.lower()=='master' }}>Master</option>
            <option {{ 'selected' if booking.payment_type and booking.payment_type.lower()=='americanExpress' }}>American express</option>
          </select>
        </div>

        <!-- Card holder Name -->
        <div class="col-md-6">
          <label for="holder_name" class="form-label fw-bold">Card holder Name</label>
          <input type="text" id="holder_name" name="holder_name" class="form-control" placeholder="Enter Card holder Name" 
           value="{{inputData.holder_name if inputData.holder_name else (booking.holder_name if booking else ' ') }}"
           {% if mode == 'delete' %}disabled{% endif %} required>
          <div id="holder_nameError" class="text-danger mt-1">{{ errorList.holder_name if errorList and errorList.holder_name }}</div>
        </div>

        <!-- Card Number -->
        <div class="col-md-6">
          <label for="card_number" class="form-label fw-bold">Card Number</label>
          <input type="text" id="card_number" name="card_number" class="form-control" placeholder="1234 5678 9012"
          value="{{ booking.card_number if booking else ' ' }}"
          {% if mode == 'delete' %}disabled{% endif %} required>
          <div id="card_numberError" class="text-danger mt-1">{{ errorList.card_number if errorList and errorList.card_number }}</div>
        </div>        
        
        <!-- CVV Number -->
        <div class="col-md-6">
          <label for="CVV" class="form-label fw-bold">CVV Number</label>
          <input type="text" id="CVV" name="CVV" class="form-control" placeholder="123"
          value="{{ booking.CVV if booking else ' ' }}"
          {% if mode == 'delete' %}disabled{% endif %} required>
          <div id="CVVError" class="text-danger mt-1">{{ errorList.CVV if errorList and errorList.CVV }}</div>
        </div> 

<div class="row justify-content-center mt-4">
<!-- Invoice -->
<div class="col-md-6">
  <div class="card border shadow-sm">
    <div class="card-header bg-dark text-white fw-bold">
      ðŸ§¾ Invoice
    </div>
    <div class="card-body">
      <div class="d-flex justify-content-between">
        <span>Room price</span>
        <span>
          $<span id="one_room_price">{{ price_per_room if mode!='insert' else 0 }}</span>
        </span>
      </div>

      <div class="d-flex justify-content-between">
        <span>Stay</span>
        <span><span id="stays">{{ stays if mode != 'insert' else 0 }}</span> night(s)</span>
      </div>

      <hr>

      <div class="d-flex justify-content-between fw-bold fs-5">
        <span>Total price</span>
        <span class="text-success">
        {% if mode == 'insert' %}
          $<span id="room_price_display">0</span>
          <input type="hidden" name="price" id="price">
        {% else %}
          ${{ booking.totalprice if booking else 0 }}
        {% endif %}
        </span>
      </div>
    </div>
  </div>
</div>

        <!-- Buttons -->
        <div class="col-3 d-flex flex-column justify-content-center align-items-center mt-4">
          <button type="submit" class="btn {% if mode == 'delete' %}btn-danger{% else %}btn-success{% endif %} mb-3 w-100">
            {% if mode == 'insert' %}
                <i class="bi bi-save"></i> Add New
            {% elif mode == 'update' %}
                <i class="bi bi-pencil-square"></i> Update
            {% else %}
                <i class="bi bi-trash"></i> Delete
            {% endif %}
          </button>
          <a href="{{ url_for('manage_booking') }}" class="btn btn-secondary w-100">
            <i class="bi bi-x-circle"></i> Cancel
          </a>
      </div>
</div> <!-- combining invoice and buttons -->

    </div>
      </form>
    </div>
  </div>
</div>

{% if mode == 'insert' %}
<script>
document.addEventListener("DOMContentLoaded", function() {
  const roomSelect = document.getElementById("room_no");
  const checkIn = document.getElementById("check_in_date");
  const checkOut = document.getElementById("Check-Out-Date");
  const priceDisplay = document.getElementById("room_price_display");
  const priceInput = document.getElementById("price");
  const one_room_price = document.getElementById("one_room_price");
  const stays = document.getElementById("stays");

  function updatePrice() {
    const room_no = roomSelect.value;
    const check_in = checkIn.value;
    const check_out = checkOut.value;

    if (!room_no || !check_in || !check_out) {
      priceDisplay.textContent = "0.00";
      priceInput.value = "";
      return;
    }

    fetch(`/get_room_price?room_no=${room_no}`)
      .then(response => response.json())
      .then(data => {
        // Optionally, multiply by nights if you want total
        const checkInDate = new Date(check_in);
        const checkOutDate = new Date(check_out);
        const today = new Date();

        // Normalize time to midnight to avoid time issues
        today.setHours(0,0,0,0);
        checkInDate.setHours(0,0,0,0);
        checkOutDate.setHours(0,0,0,0);

            // Validation
        if (checkInDate < today) {
          alert("Check-in date cannot be earlier than today!");
          priceDisplay.textContent = "0.00";
          priceInput.value = "";
          return;
        }

        if (checkOutDate < checkInDate) {
          alert("Check-out date cannot be earlier than check-in date!");
          priceDisplay.textContent = "0.00";
          priceInput.value = "";
          return;
        }

        const diffTime = Math.abs(checkOutDate - checkInDate);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        const totalPrice = data.price * diffDays;
        priceDisplay.textContent = totalPrice.toFixed(2);
        priceInput.value = totalPrice;
        one_room_price.textContent = data.price
        stays.textContent = diffDays
      });
  }

  roomSelect.addEventListener("change", updatePrice);
  checkIn.addEventListener("change", updatePrice);
  checkOut.addEventListener("change", updatePrice);
});
</script>
{% endif %}
{% endblock %}